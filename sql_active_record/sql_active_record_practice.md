
# railsconsoleで改行しながら入力する方法
記述するコードをbeginとendで囲う。

# 逆引きネタ帳らしきもの
## 単数テーブル
```rb
## 例：テーブル（生徒）をカラム（出席番号）の値（3）で絞って取得
テーブル.where(カラム: 絞りたい値)

## 例：テーブル（生徒）をカラム（苗字）の値（田中）で絞ったときに一番若いIDのレコードを取得
テーブル.find_by(カラム: 絞りたい値)

## 例：テーブル（生徒）の指定したカラム（id、フルネーム）だけ取得　※whereなどで指定しないとたくさん出るので注意
テーブル.select(:カラム, :カラム)

## 例：テーブル（生徒の年齢）で、カラム（生年月日）が【2005年中】の者だけを取得
テーブル.where(カラム: Time.new(2005).beginning_of_year..Time.new(2005).end_of_year)

## 例：テーブル（生徒の年齢）で、カラム（入学年月日）が【空欄】の者だけを取得
テーブル.where(カラム: nil)

## 例：テーブル（学費）で、まとめたいカラム（月）ごとに合計したいカラム（預かり金額）の合計を取得
テーブル.group(:まとめたいカラム).sum("合計したいカラム")
```

▼ 参考：[【Rails】ActiveRecordで合計(sum)した列に列名(AS句)をつけたい【GROUP BY】](https://qiita.com/Orangina1050/items/93dd407ac54f855d9d7d)
```rb
## 例：テーブル（学費）で、まとめたいカラム（月、取得したいカラムも同じ）ごとに 合計したいカラム（預かり金額）の合計で【多い順に5件】を取得
テーブル.select("取得したいカラム（複数可能）, sum(合計したいカラム) as 合計行に付けるカラム名")
.group(:まとめたいカラム).limit(5).order(合計行に付けるカラム名: :desc)  

## 例：テーブル（学費）で、まとめたいカラム（月、取得したいカラムも同じ）ごとに カウント行カラム（徴収済）の【カウントが60以上の多い順】を取得
テーブル.select("取得したいカラム（複数可能）, count(*) as カウント行に付けるカラム名")  
.group(:まとめたいカラム).having("カウント行に付けるカラム名 >= 60").order(カウント行に付けるカラム名: :desc)

```
## 複数テーブル
```rb
## 例：テーブル2（出席者）で、テーブル1（生徒）で指定した情報（カラム（苗字）の値＝田中）と一致するレコードの数を取得
テーブル1.find_by(カラム名: 絞りたい値).テーブル2s.size

## 例：テーブル2（出席者）にテーブル1（生徒）の情報を結合し、テーブル1（生徒）のカラム（苗字）の値が田中であるレコードの数を取得
テーブル2.joins(:テーブル1s).where(テーブル1s: { カラム: 絞りたい値 }).size

## 例：テーブル1 （生徒）の情報を取得。
## 条件は、テーブル3（生徒の年齢）のカラム（生年月日）で値（2005年中）となっていること。
### 対応するカラム有：テーブル1⇔テーブル2、テーブル2⇔テーブル3 　
### ※テーブル2は中間テーブルではない
テーブル1.joins(テーブル2s: :テーブル3s).where({ テーブル3s: カラム: 値 })

## 例：山田さん（テーブル6）が購入した本の著者情報（テーブル1）を取得する。テーブルは以下6つ。
### テーブル1　= 著者
### テーブル2　= 本_著者（中間テーブル）
### テーブル3　= 本
### テーブル4　= 在庫
### テーブル5　= 販売履歴
### テーブル6　= 購入者
## ▼アソシエーション接続
###  テーブル6 → テーブル5 → テーブル4 → テーブル3 → テーブル1
テーブル1.joins(テーブル3s: { テーブル4s: { テーブル5s: :テーブル6s}})
.where(テーブル6s: {カラム: 絞りたい値 })
# テーブルN,のNが大きい方が奥になるような入れ子構造になっている。
# テーブル2が中間テーブルでない場合は、テーブル2もこの入れ子の仲間入り。
```


## 【select・group】テーブル数によるの書き方の違い
※ざっくり。  
selectについては、[補足](./sql_active_record_practice.md#補足selectシンボルとselect文字列の使い分け) のように、joinsを使っていても「select(:シンボル)」で書くケースもある。
| ケース | selectの書き方 | groupの書き方 | 備考 |
| --- | --- | --- | --- |
| 単一テーブル | `テーブル.select(:カラム1, :カラム2)` | `テーブル.group(:カラム)` | テーブル名の指定不要 |
| 複数テーブル（joins使用） | `テーブル.joins(...).select("テーブル1.カラム, テーブル2.カラム")` | `テーブル.joins(...).group("テーブル.カラム")` | 明示的に `テーブル.カラム` 指定が必要 |
| 複数テーブル（includes使用 + SQL書く場合） | 同上（includesでもSQLを書くなら明示） | 同上 | `includes`は通常Eager LoadingなのでSQLで指定しないこともある |

#### 補足:「select(:シンボル)」と「select("文字列")」の使い分け
| 使用場面／条件                     | select(\:symbol) | select("文字列")           |
| --------------------------- | ---------------- | ----------------------- |
| 自分のテーブルの複数カラムを取得したい         | ◎                | △（書けるけど冗長）              |
| joinした他テーブルのカラムも省略して取りたい    | ◯（可能）            | ◎ 明示的に書きたい時             |
| カラム名に重複がある（例: 両テーブルに`id`あり） | △（どっちのid？）       | ◎ `table.id AS user_id` |
| 関数・演算・AS句で加工したい             | ×                | ◎ 必須                    |
| SQLをそのまま流し込みたい              | ×                | ◎                       |

## 【where】複数の条件を指定したい場合
参考：[複数の関連名がある場合のwhereメソッドの指定方法(pikawaka.com)](https://pikawaka.com/rails/joins#複数の関連名がある場合のwhereメソッドの指定方法)
```rb
# 姓：田中、名：太郎さんが所属する部活を取得
## テーブル1:生徒（姓名含む）　テーブル2:部活
テーブル1.joins(:テーブル2s).where(テーブル1s: { カラム名: '絞りたい値', カラム名: '絞りたい値' })

# 合唱部に所属する2年生の生徒のレコードを取得
## テーブル1:生徒　テーブル2:部活　テーブル3:学年
テーブル1.joins(:テーブル2s, :テーブル3s).where(テーブル2s: { カラム名: '絞りたい値' }, テーブル3s: {  カラム名: '絞りたい値' })

# 【2年生以上】の生徒で、姓：田中、名：太郎さんレコードを取得
## テーブル1:生徒（姓名含む）　テーブル2:学年
###　ダブルクォーテーションつけ忘れ注意！
テーブル1.joins(:テーブル2s).where("カラム名 >= 2")where(テーブル1s: { カラム名: '絞りたい値', カラム名: '絞りたい値' })
```

# 時間関連の書き方
### Time.new
🔖[Ruby3.4リファレンスマニュアル](https://docs.ruby-lang.org/ja/latest/method/Time/s/new.html)  
Time.new(year, mon = nil, day = nil, hour = nil, min = nil, sec = nil, in: nil)  
 → 引数で指定した地方時の Time オブジェクトを返します。

mon day hour min sec に nil を指定した場合の値は、その引数がとり得る最小の値です。  
zone と in に nil を指定した場合の値は、現在のタイムゾーンに従います。  

```rb
Time.new(2005).beginning_of_year..Time.new(2005).end_of_year
# => 2005-01-01 00:00:00 +0900..2005-12-31 23:59:59.999999999 +0900

p Time.new(2008, 6, 21, 13, 30, 0, "+09:00") 
# => 2008-06-21 13:30:00 +0900
```

### beginning_of_year、end_of_year 
🔖[Railsガイド](https://railsguides.jp/active_support_core_extensions.html#beginning-of-year%E3%80%81end-of-year)  
beginning_of_yearメソッドとend_of_yearメソッドは、その年の「最初の日」と「最後の日」をそれぞれ返します。  
  
```rb
d = Date.new(2010, 5, 9) # => Sun, 09 May 2010
d.beginning_of_year      # => Fri, 01 Jan 2010
d.end_of_year            # => Fri, 31 Dec 2010
```